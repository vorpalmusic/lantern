#!/bin/bash
## lantern
# author: JackDaw
version="v0.0.17"

### GRAB ROOTDIR AND PATH VARS
rootdir="$(cd -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
. "$rootdir/lib/pathfinder"

## LOAD LIBRARIES
. "$ROOTDIR/lib/colors"

CONFIG="$ROOTDIR/.config"
[ -f "$CONFIG" ] && . "$CONFIG"

# Run bootstrap only if depcheck==0
if [ "$depcheck" -eq 0 ]; then
  "$SCRIPTDIR/bootstrap"

  # Re-source config in case bootstrap updated depcheck/init
  [ -f "$CONFIG" ] && . "$CONFIG"
  depcheck="${depcheck:-0}"
fi

# -----------
# Input flags and validation
# ----------

# Do NOT allow running Lantern as root; use regular user + internal sudo
if [ "$EUID" -eq 0 ]; then
  echo -e "${red}[!] Do not run lantern with sudo. Run it as a normal user, e.g.:${end}"
  echo -e "${blue}    lantern <IP>${end}"
  exit 1
fi

# Simple usage helper
usage() {
  echo -e "\n${yellow}[!]${end} ${purple}Usage:${end} ${blue}$0 <IP>${end}"
  echo -e "   ${purple}or:${end} ${blue}$0 -v | --version${end}"
  echo -e "   ${purple}or:${end} ${blue}$0 -h | --help${end}"
}

arg="${1:-}"

case "$arg" in
  -v|--version)
    echo "Lantern $version"
    exit 0
    ;;
  -h|--help|"")
    usage
    # empty arg or -h/--help: treat as “not enough arguments”
    [ -z "$arg" ] && exit 1 || exit 0
    ;;
  -*)
    # any other flag = unknown option
    echo -e "${red}[!] Unknown option:${end} ${blue}$arg${end}"
    usage
    exit 1
    ;;
esac

# By this point, $1 must be an IP (or at least, not a flag)
target="$1"

# ---------------------------
# Output directory logic
# ---------------------------
# Keep OUTDIR under the caller's current working directory
BASEDIR="$(pwd)"
OUTDIR="${BASEDIR}/${target}"
REPORTDIR="${OUTDIR}/report"

## DISCLAIMER
echo -e "${yellow}[!] LANTERN is intended for${end} ${red}ETHICAL hacking only.${end}"
echo -e "${yellow}[!] Please do not use it to break the law.${end}"

## HANDLE PRIVILEGES (for nmap SYN scans only)
echo -e "${yellow}[*]${end} ${purple}Lantern needs elevated privileges ONLY for certain tasks. The rest of the commands are run as normal user.${end}"
if ! sudo -v; then
    echo -e "${red}[!] sudo authentication failed; cannot run privileged nmap scans.${end}"
    exit 1
fi

echo -e "${yellow}[*]${end} ${purple}Lantern config file is at:${end} ${blue}${CONFIG}${end}"

## MAKE OUTPUT FOLDER BASED ON TARGET IP + REPORT SUBFOLDER
mkdir -p "$OUTDIR" "$REPORTDIR"
echo -e "${yellow}[*]${end} ${purple}Using output directory:${end} ${blue}$OUTDIR${end}"

"$SCRIPTDIR/banner"        ## cue banner

## BEGIN WORK.
### run fast discovery scan just to find open ports (no live verbose spam)
echo -e "\n${yellow}[*]${end} ${purple}Rapid nmap port discovery on${end} ${blue}$target${end}${purple}...${end}"

ALLPORTS="$REPORTDIR/allPorts"
PART1="$REPORTDIR/allPorts.p1"
PART2="$REPORTDIR/allPorts.p2"
PART3="$REPORTDIR/allPorts.p3"

# Clean old artifacts if they exist
rm -f "$ALLPORTS" "$PART1" "$PART2" "$PART3"

# Run three concurrent range scans to speed up discovery.
# Combined, these cover 1–65535 without overlap:
#   1–22000, 22001–44000, 44001–65535
sudo /usr/bin/nmap \
  -p1-22000 --open -sS -n -Pn \
  --min-rate 2500 \
  --max-retries 1 \
  -T3 \
  -oG "$PART1" \
  "$target" >/dev/null 2>&1 &

pid1=$!

sudo /usr/bin/nmap \
  -p22001-44000 --open -sS -n -Pn \
  --min-rate 2500 \
  --max-retries 1 \
  -T3 \
  -oG "$PART2" \
  "$target" >/dev/null 2>&1 &

pid2=$!

sudo /usr/bin/nmap \
  -p44001-65535 --open -sS -n -Pn \
  --min-rate 2500 \
  --max-retries 1 \
  -T3 \
  -oG "$PART3" \
  "$target" >/dev/null 2>&1 &

pid3=$!

# Wait for all three discovery scans to finish
wait "$pid1" "$pid2" "$pid3" 2>/dev/null || true

# Merge into a single greppable file so the rest of the script
# can continue to treat $ALLPORTS exactly as before.
: > "$ALLPORTS"
[ -f "$PART1" ] && cat "$PART1" >> "$ALLPORTS"
[ -f "$PART2" ] && cat "$PART2" >> "$ALLPORTS"
[ -f "$PART3" ] && cat "$PART3" >> "$ALLPORTS"

# Optionally clean up the parts
rm -f "$PART1" "$PART2" "$PART3"

# If greppable file exists, extract ports and print a compact summary only
if [ -f "$ALLPORTS" ]; then
  discovered_ports=$(grep -oP '\d{1,5}/open' "$ALLPORTS" | cut -d'/' -f1 | sort -n -u)

  if [ -n "$discovered_ports" ]; then
    summary="$(echo "$discovered_ports" | tr '\n' ',' | sed 's/,$//')"
    echo -e "${yellow}[*]${end} ${purple}Open ports:${end} ${blue}${summary}${end}\n"
  else
    echo -e "${red}[!] No open ports discovered in greppable output.${end}\n"
  fi
else
  echo -e "${red}[!] Nmap greppable output missing: $ALLPORTS${end}\n"
fi

### grab all those ports from the nmap scan and put them in a list
ports=""
if [ -f "$ALLPORTS" ]; then
  ports=$(grep -oP '\d{1,5}/open' "$ALLPORTS" | cut -d '/' -f1 | xargs | tr ' ' ',')
fi

# --- targeted scan (only if we have ports, runs synchronously) ---
TARGETED_XML="$REPORTDIR/targetedXML"

if [ -n "$ports" ]; then
  echo -e "${yellow}[*]${end} ${purple}Targeted scanning on discovered ports...if there are many, this could take a while.${end}" 
  echo -e "${purple}    Results will populate the web report.${end}"
  sudo /usr/bin/nmap -sCV -p"$ports" -n -Pn --max-retries 2 --host-timeout 120s "$target" \
       -oX "$TARGETED_XML" >/dev/null 2>&1
else
  echo -e "${yellow}[!] No open ports detected; skipping targeted scan.${end}"
fi

echo $IP

## add-hosts runs to discover any possible domains in the nmap output
sudo bash "$ROOTDIR/scripts/add-hosts" \
  "$OUTDIR" \
  "$target" \
  "" \
  --deny-file "$LISTDIR/deny-domains" \
  --mode nmap

# --- service dispatch (SSH / HTTP / HTTP-CMS, etc.) ---
"$ROOTDIR/scripts/dispatch" "$OUTDIR" "$target" "$TARGETED_XML" "$ports" || true

# ... generate HTML deep dive
: "${NMAP_XSL:=/usr/share/nmap/nmap.xsl}"
if [ ! -f "$NMAP_XSL" ]; then
  NMAP_XSL="$(find /usr/local/share /usr/share /opt -type f -name nmap.xsl 2>/dev/null | head -n1 || true)"
fi

REPORT_HTML="$REPORTDIR/index.html"

if [ -s "$TARGETED_XML" ]; then
  if [ -n "$NMAP_XSL" ] && [ -f "$NMAP_XSL" ]; then
    xsltproc -o "$REPORT_HTML" "$NMAP_XSL" "$TARGETED_XML" || echo "[!] xsltproc failed"
    rep="$ROOTDIR/scripts/reporter"
    if [ -x "$rep" ]; then
      "$rep" "$OUTDIR" || echo "[!] reporter failed"
    else
      echo "[!] reporter not found or not executable; skipping module summary"
    fi
  else
    echo "[!] nmap.xsl stylesheet not found; cannot generate HTML"
  fi
else
  echo "[!] targetedXML missing or empty; skipping HTML generation"
fi

# --- wait briefly for index.html to appear (fast loop, up to ~5 seconds) ---
tries=0
while [ $tries -lt 50 ] && [ ! -s "$REPORT_HTML" ]; do
  sleep 0.1
  tries=$((tries + 1))
done

if [ -s "$REPORT_HTML" ]; then
  # 1) Ensure no stale server is hogging 9999 (port conflicts cause silent failures)
  if command -v lsof >/dev/null 2>&1; then
    stale_pids="$(lsof -tiTCP:9999 -sTCP:LISTEN 2>/dev/null || true)"
    if [ -n "$stale_pids" ]; then
      echo "[*] Cleaning up existing server(s) on 9999: $stale_pids"
      kill $stale_pids 2>/dev/null || true
      sleep 0.2
    fi
  else
    stale_pids="$(/usr/sbin/fuser -n tcp 9999 2>/dev/null || true)"
    [ -n "$stale_pids" ] && { echo "[*] Cleaning up existing server(s) on 9999: $stale_pids"; kill $stale_pids 2>/dev/null || true; sleep 0.2; }
  fi

  python3 -m http.server 9999 --bind 127.0.0.1 -d "$OUTDIR" >/dev/null 2>&1 &
  server_pid=$!
  sleep 0.15
  if ! kill -0 "$server_pid" 2>/dev/null; then
    echo "[!] http.server failed to start on 127.0.0.1:9999 (likely EADDRINUSE or bad args)."
    echo "    Try: python3 -m http.server 9999 --bind 127.0.0.1 -d \"$OUTDIR\" (without redirection) to see stderr."
    exit 1
  fi
  disown "$server_pid" 2>/dev/null || true

  url="http://127.0.0.1:9999/report/index.html"
  echo -e "${yellow}[*]${end} ${purple}Report:${end} ${blue}$url${end}"

  if command -v curl >/dev/null 2>&1; then
    local_sz=$(wc -c < "$REPORT_HTML" 2>/dev/null || echo 0)
    remote_sz=$(curl -fsSI "$url" | awk 'tolower($1)=="content-length:"{print $2}' | tr -d '\r' )
    if [ -n "$remote_sz" ] && [ "$remote_sz" != "$local_sz" ]; then
      echo "[!] Warning: server on 9999 is not serving the expected index.html (size $remote_sz vs $local_sz)."
      echo "    A stale server or different docroot may still be active."
    elif ! curl -fsS "$url" >/dev/null 2>&1; then
      echo "[!] Warning: server started but index.html not reachable at $url"
    fi
  fi

  ( xdg-open "$url" >/dev/null 2>&1 || /usr/bin/firefox "$url" >/dev/null 2>&1 ) &
else
  echo "[!] index.html not found; not starting web server"
fi

exit 0
