#!/usr/bin/env bash
set -euo pipefail

OUTDIR="${1:-}"
if [ -z "$OUTDIR" ] || [ ! -d "$OUTDIR" ]; then
  echo "[!] Usage: scripts/reporter <OUTDIR>" >&2
  exit 2
fi

# index.html now lives under OUTDIR/report/
IDX="$OUTDIR/report/index.html"
if [ ! -f "$IDX" ]; then
  echo "[!] index.html not found in $OUTDIR/report; skipping reporter"
  exit 0
fi

FRAGDIR="$OUTDIR/report/fragments"
mkdir -p "$FRAGDIR"

# ---------------- helpers ----------------
insert_before_body_close() {
  local src_html="$1"
  local insert_file="$2"
  local tmp="${src_html}.tmp.$$"
  awk -v frag="$(cat "$insert_file")" '
    BEGIN{done=0}
    {
      print $0
      if(!done && $0 ~ /<\/[Bb][Oo][Dd][Yy]>/) { print frag; done=1 }
    }
    END{ if(!done) print frag }
  ' "$src_html" > "$tmp" 2>/dev/null && mv "$tmp" "$src_html"
}

html_escape() {
  sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'
}

emit_links() {
  local sep=""
  local item
  for item in "$@"; do
    [ -n "$item" ] || continue
    printf "%s%s" "$sep" "$item"
    sep=" | "
  done
}

safe_count() {
  local f="$1"
  [ -s "$f" ] && wc -l < "$f" 2>/dev/null || echo 0
}

safe_size() {
  local f="$1"
  if [ -e "$f" ]; then
    stat -c%s "$f" 2>/dev/null || wc -c < "$f" 2>/dev/null || echo 0
  else
    echo 0
  fi
}

# Build an <a> tag if the path exists.
# relpath is relative to OUTDIR (e.g. "http/80/body.html")
# index.html lives at OUTDIR/report/index.html, so links must be "../$relpath"
# mode=nonempty (default) requires non-empty file; mode=allow_empty links even 0-byte files.
make_link_if() {
  local label="$1" relpath="$2" mode="${3:-nonempty}"
  local abspath="$OUTDIR/$relpath"
  if [ "$mode" = "allow_empty" ]; then
    [ -e "$abspath" ] || return 0
  else
    [ -s "$abspath" ] || return 0
  fi
  printf '<a href="../%s">%s</a>' "$relpath" "$label"
}

# ---------------- HTTP summary fragment (10-http.html) ----------------
build_http_fragment() {
  local frag="$FRAGDIR/10-http.html"
  : > "$frag"

  echo '<h3>HTTP Summary</h3>' >> "$frag"

  if [ ! -d "$OUTDIR/http" ]; then
    echo '<p><em>No HTTP artifacts found.</em></p>' >> "$frag"
    return
  fi

  shopt -s nullglob
  local ports=( "$OUTDIR"/http/* )
  shopt -u nullglob

  if [ ${#ports[@]} -eq 0 ]; then
    echo '<p><em>No HTTP artifacts found.</em></p>' >> "$frag"
    return
  fi

  local portdir
  for portdir in "${ports[@]}"; do
    [ -d "$portdir" ] || continue
    local port title esc_title
    port="$(basename "$portdir")"

    if [ -s "$portdir/title.txt" ]; then
      title="$(tr -d '\r\n' < "$portdir/title.txt")"
    else
      title="(no title collected)"
    fi
    esc_title="$(printf '%s' "$title" | html_escape)"

    local hosts_count emails_count body_html_sz body_json_sz
    hosts_count="$(safe_count "$portdir/hosts_from_body.txt")"
    emails_count="$(safe_count "$portdir/emails.txt")"
    body_html_sz="$(safe_size "$portdir/body.html")"
    body_json_sz="$(safe_size "$portdir/body.json")"

    local link_items=()
    link_items+=("$(make_link_if 'body.html'   "http/$port/body.html")")
    link_items+=("$(make_link_if 'body.json'   "http/$port/body.json" allow_empty)")
    link_items+=("$(make_link_if 'headers'     "http/$port/headers.txt")")
    link_items+=("$(make_link_if 'robots'      "http/$port/robots.txt")")
    link_items+=("$(make_link_if 'sitemap'     "http/$port/sitemap.xml")")
    link_items+=("$(make_link_if 'whatweb'     "http/$port/whatweb.txt")")
    link_items+=("$(make_link_if 'emails'      "http/$port/emails.txt")")
    link_items+=("$(make_link_if 'hosts'       "http/$port/hosts_from_body.txt")")
    link_items+=("$(make_link_if 'cert'        "http/$port/cert.txt")")

    local extra_items=()
    shopt -s nullglob
    local fpath
    for fpath in "$portdir"/*; do
      [ -f "$fpath" ] || continue
      local bn rel
      bn="$(basename "$fpath")"
      [ "$bn" = "title.txt" ] && continue
      case "$bn" in
        body.html|body.json|headers.txt|robots.txt|sitemap.xml|whatweb.txt|emails.txt|hosts_from_body.txt|cert.txt)
          continue
          ;;
      esac
      rel="http/$port/$bn"
      extra_items+=( "$(make_link_if "$bn" "$rel" allow_empty)" )
    done
    shopt -u nullglob

    local links
    links="$(emit_links "${link_items[@]}" "${extra_items[@]}")"

    cat >> "$frag" <<PORT
<div class="lantern-port">
  <h4>Port <code>$port</code> — $esc_title</h4>
  <div class="lantern-meta">
    hosts_from_body: $hosts_count &nbsp;•&nbsp; emails: $emails_count &nbsp;•&nbsp; body.html bytes: $body_html_sz &nbsp;•&nbsp; body.json bytes: $body_json_sz
  </div>
  <div class="lantern-files">
    ${links:-<em>No per-port artifacts present.</em>}
  </div>
PORT

    # Inline WhatWeb output in two-column block (if present)
    if [ -s "$portdir/whatweb.txt" ]; then
      {
        echo '  <details open style="margin-top:.4rem">'
        echo '    <summary>WhatWeb Output</summary>'
        echo '    <pre class="lantern-pre-twocol">'
        sed -n '1,400p' "$portdir/whatweb.txt" | html_escape
        echo '    </pre>'
        echo '  </details>'
      } >> "$frag"
    fi

    echo "</div>" >> "$frag"
  done
}

# ---------------- CMS findings fragment (20-cms.html) ----------------
build_cms_fragment() {
  local frag="$FRAGDIR/20-cms.html"
  mapfile -d '' cms_dirs < <(find "$OUTDIR/http" -maxdepth 2 -type d -name cms -print0 2>/dev/null || true)
  [ ${#cms_dirs[@]} -eq 0 ] && return 0

  local qualified=()
  local cmsdir
  for cmsdir in "${cms_dirs[@]}"; do
    [ -s "$cmsdir/detected.txt" ] && qualified+=("$cmsdir")
  done
  [ ${#qualified[@]} -eq 0 ] && return 0

  : > "$frag"
  echo '<h3>CMS Findings</h3>' >> "$frag"

  for cmsdir in "${qualified[@]}"; do
    local port detected_raw detected_display
    port="$(basename "$(dirname "$cmsdir")")"
    detected_raw="$(tr -d '\r' < "$cmsdir/detected.txt")"
    detected_display="$(printf '%s\n' "$detected_raw" | paste -sd',' - | sed 's/,/, /g')"

    {
      echo "<div class=\"lantern-port\">"
      echo "  <h4>Port <code>$port</code></h4>"
      echo "  <div class=\"lantern-meta\"><strong>Detected:</strong> $(printf '%s' "$detected_display" | html_escape)</div>"
    } >> "$frag"

    # ----- WordPress block -----
    if grep -qi '^wordpress$' "$cmsdir/detected.txt"; then
      local wdir links_wp
      wdir="http/$port/cms/wordpress"
      links_wp=()
      links_wp+=("$(make_link_if 'summary.txt' "$wdir/summary.txt")")
      links_wp+=("$(make_link_if 'wpscan.txt'   "$wdir/wpscan.txt")")
      links_wp+=("$(make_link_if 'wpscan.json'  "$wdir/wpscan.json")")

      if printf '%s\n' "${links_wp[*]}" | grep -q '[^[:space:]]'; then
        echo "  <div class=\"lantern-files\"><strong>WordPress:</strong> $(emit_links "${links_wp[@]}")</div>" >> "$frag"
      fi

      # Inline WordPress summary in two-column block
      if [ -s "$OUTDIR/$wdir/summary.txt" ]; then
        echo "  <details open style=\"margin-top:.4rem\"><summary>Preview WordPress summary.txt</summary><pre class=\"lantern-pre-twocol\">" >> "$frag"
        tail -n 200 "$OUTDIR/$wdir/summary.txt" | html_escape >> "$frag"
        echo "  </pre></details>" >> "$frag"
      fi
    fi

    # ----- Joomla block -----
    if grep -qi '^joomla$' "$cmsdir/detected.txt"; then
      local jdir links_j
      jdir="http/$port/cms/joomla"
      links_j=()
      links_j+=("$(make_link_if 'summary.txt'   "$jdir/summary.txt")")

      if printf '%s\n' "${links_j[*]}" | grep -q '[^[:space:]]'; then
        echo "  <div class=\"lantern-files\"><strong>Joomla:</strong> $(emit_links "${links_j[@]}")</div>" >> "$frag"
      fi

      # Inline JoomScan output in same two-column style (strip ANSI here just in case)
      if [ -s "$OUTDIR/$jdir/joomscan.txt" ]; then
        echo "  <details open style=\"margin-top:.4rem\"><summary>View Joomla scan details (JoomScan)</summary><pre class=\"lantern-pre-twocol\">" >> "$frag"
        sed -n '1,400p' "$OUTDIR/$jdir/joomscan.txt" \
          | sed -r 's/\x1B\[[0-9;]*[A-Za-z]//g' \
          | html_escape >> "$frag"
        echo "  </pre></details>" >> "$frag"
      fi
    fi

    echo "</div>" >> "$frag"
  done
}

# ---------------- assemble & inject ----------------
TMP="$(mktemp)"
cat > "$TMP" <<'HEAD'
<style>
#lantern-report{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Liberation Sans",sans-serif;margin:2rem 0;border-top:2px solid #e5e7eb;padding-top:1rem}
#lantern-report h2{margin:0 0 .75rem;font-size:1.35rem}
#lantern-report h3{margin:1rem 0 .5rem;font-size:1.1rem}
#lantern-report h4{margin:.6rem 0 .3rem;font-size:1.02rem}
#lantern-report .lantern-port{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:10px 0}
#lantern-report .lantern-meta{color:#555;font-size:.9rem;margin-bottom:.4rem}
#lantern-report code{background:#f6f8fa;padding:0 .3rem;border-radius:6px}
#lantern-report .lantern-files a{text-decoration:none}

/* Shared two-column tool output */
#lantern-report pre.lantern-pre-twocol{
  max-height:400px;
  overflow:auto;
  background:#020617;
  color:#e5e7eb;
  padding:.5rem .75rem;
  border-radius:6px;
  font-size:.8rem;
  column-count:2;
  column-gap:1.5rem;
  white-space:pre-wrap;
}
</style>
<section id="lantern-report">
  <h2>Lantern Modules</h2>
HEAD

build_http_fragment
build_cms_fragment

if compgen -G "$FRAGDIR"/* >/dev/null; then
  for f in $(ls -1v "$FRAGDIR"/*); do
    echo "<section class=\"lantern-fragment\" id=\"$(basename "$f" | sed 's/[^a-zA-Z0-9_-]/_/g')\">" >> "$TMP"
    cat "$f" >> "$TMP"
    echo "</section>" >> "$TMP"
  done
else
  echo "<p><em>No module fragments produced output.</em></p>" >> "$TMP"
fi

echo "</section>" >> "$TMP"

insert_before_body_close "$IDX" "$TMP"
rm -f "$TMP"

echo "[*] Reporter appended module summary to $IDX"
