#!/usr/bin/env bash
## reporter

### GRAB ROOTDIR AND PATH VARS
rootdir="$(cd -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")"/.. >/dev/null 2>&1 && pwd)"
. "$rootdir/lib/colors"

OUTDIR="${1:-}"
if [ -z "$OUTDIR" ] || [ ! -d "$OUTDIR" ]; then
  echo "[!] Usage: scripts/reporter <OUTDIR>" >&2
  exit 2
fi

# index.html now lives under OUTDIR/report/
IDX="$OUTDIR/report/index.html"
if [ ! -f "$IDX" ]; then
  echo "[!] index.html not found in $OUTDIR/report; skipping reporter"
  exit 0
fi

FRAGDIR="$OUTDIR/report/fragments"
mkdir -p "$FRAGDIR"

TREASURE_REPORTER="$rootdir/scripts/treasure-reporter"

# ---------------- helpers ----------------
insert_before_body_close() {
  local src_html="$1"
  local insert_file="$2"
  local tmp="${src_html}.tmp.$$"
  awk -v frag="$(cat "$insert_file")" '
    BEGIN{done=0}
    {
      print $0
      if(!done && $0 ~ /<\/[Bb][Oo][Dd][Yy]>/) { print frag; done=1 }
    }
    END{ if(!done) print frag }
  ' "$src_html" > "$tmp" 2>/dev/null && mv "$tmp" "$src_html"
}

html_escape() {
  sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'
}

emit_links() {
  local sep=""
  local item
  for item in "$@"; do
    [ -n "$item" ] || continue
    printf "%s%s" "$sep" "$item"
    sep=" | "
  done
}

safe_count() {
  local f="$1"
  [ -s "$f" ] && wc -l < "$f" 2>/dev/null || echo 0
}

safe_size() {
  local f="$1"
  if [ -e "$f" ]; then
    stat -c%s "$f" 2>/dev/null || wc -c < "$f" 2>/dev/null || echo 0
  else
    echo 0
  fi
}

# Build an <a> tag if the path exists.
# relpath is relative to OUTDIR (e.g. "http/80/body.html")
# index.html lives at OUTDIR/report/index.html, so links must be "../$relpath"
# mode=nonempty (default) requires non-empty file; mode=allow_empty links even 0-byte files.
make_link_if() {
  local label="$1" relpath="$2" mode="${3:-nonempty}"
  local abspath="$OUTDIR/$relpath"
  if [ "$mode" = "allow_empty" ]; then
    [ -e "$abspath" ] || return 0
  else
    [ -s "$abspath" ] || return 0
  fi
  printf '<a href="../%s">%s</a>' "$relpath" "$label"
}

# ---------------- SSH summary fragment (05-ssh.html) ----------------
build_ssh_fragment() {
  local frag="$FRAGDIR/05-ssh.html"

  if [ ! -d "$OUTDIR/ssh" ]; then
    return 0
  fi

  # ports as basenames, sorted numerically
  local ports=()
  mapfile -t ports < <(find "$OUTDIR/ssh" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort -n)

  if [ ${#ports[@]} -eq 0 ]; then
    return 0
  fi

  : > "$frag"
  echo '<h3>SSH Summary</h3>' >> "$frag"

  local port portdir
  for port in "${ports[@]}"; do
    portdir="$OUTDIR/ssh/$port"
    [ -d "$portdir" ] || continue

    local software esc_software
    software="unknown"

    if [ -s "$portdir/summary.txt" ]; then
      software="$(grep -m1 '^Software / banner:' "$portdir/summary.txt" 2>/dev/null | sed 's/^Software \/ banner:[[:space:]]*//')"
      [ -z "$software" ] && software="unknown"
    fi

    esc_software="$(printf '%s' "$software" | html_escape)"

    # Grab notable lines from ssh-audit.txt (FATAL or CVE-)
    local notable
    notable=""
    if [ -s "$portdir/ssh-audit.txt" ]; then
      notable="$(grep -E 'FATAL|CVE-' "$portdir/ssh-audit.txt" 2>/dev/null | head -n 8 || true)"
    fi

    # Build basic links to raw SSH artifacts
    local link_items=()
    link_items+=("$(make_link_if 'ssh-audit' "ssh/$port/ssh-audit.txt")")
    link_items+=("$(make_link_if 'nmap ssh'  "ssh/$port/nmap_ssh.txt")")
    link_items+=("$(make_link_if 'summary'   "ssh/$port/summary.txt")")

    local links
    links="$(emit_links "${link_items[@]}")"

    {
      echo "<div class=\"lantern-port\">"
      echo "  <h4>Port <code>$port</code> — SSH</h4>"
      echo "  <div class=\"lantern-meta\">"
      echo "    <strong>Software:</strong> $esc_software"
      echo "  </div>"
    } >> "$frag"

    # Inline notable findings (if any) directly above links and details
    if [ -n "$notable" ]; then
      echo "  <div class=\"lantern-meta lantern-ssh-notable\"><strong>Notable SSH findings:</strong><br><pre>" >> "$frag"
      printf '%s\n' "$notable" | html_escape >> "$frag"
      echo "  </pre></div>" >> "$frag"
    fi

    echo "  <div class=\"lantern-files\">${links:-<em>No SSH artifacts present.</em>}</div>" >> "$frag"

    # SSH preview: single-column, scrollable, hard-wrapped (special CSS class)
    if [ -s "$portdir/ssh-audit.txt" ]; then
      echo "  <details style=\"margin-top:.4rem\"><summary>View full SSH analysis (ssh-audit)</summary><pre class=\"lantern-pre-ssh\">" >> "$frag"
      sed -n '1,400p' "$portdir/ssh-audit.txt" | html_escape >> "$frag"
      echo "  </pre></details>" >> "$frag"
    fi

    echo "</div>" >> "$frag"
  done
}

# ---------------- FTP summary fragment (07-ftp.html) ----------------
build_ftp_fragment() {
  local frag="$FRAGDIR/07-ftp.html"

  if [ ! -d "$OUTDIR/ftp" ]; then
    return 0
  fi

  local ports=()
  mapfile -t ports < <(find "$OUTDIR/ftp" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort -n)
  [ ${#ports[@]} -eq 0 ] && return 0

  : > "$frag"
  echo "<h3>FTP Summary</h3>" >> "$frag"

  local port portdir
  for port in "${ports[@]}"; do
    portdir="$OUTDIR/ftp/$port"
    [ -d "$portdir" ] || continue

    # summary fields extracted from summary.txt generated by ftp-master
    local login_ok perms esc_perms
    local dircount filecount

    login_ok="unknown"
    perms="unknown"
    dircount=0
    filecount=0

    if [ -s "$portdir/summary.txt" ]; then
      login_ok="$(grep -m1 '^Anonymous login:' "$portdir/summary.txt" | sed 's/.*Anonymous login:[[:space:]]*//')"
      perms="$(grep -m1 '^Permissions:' "$portdir/summary.txt" | sed 's/.*Permissions:[[:space:]]*//')"
      dircount="$(grep -m1 '^Directories:' "$portdir/summary.txt" | sed 's/.*Directories:[[:space:]]*//')"
      filecount="$(grep -m1 '^Files:' "$portdir/summary.txt" | sed 's/.*Files:[[:space:]]*//')"
    fi

    esc_perms="$(printf '%s' "$perms" | html_escape)"

    # Build basic file links
    local link_items=()
    link_items+=("$(make_link_if 'listing.txt'   "ftp/$port/listing.txt" allow_empty)")
    link_items+=("$(make_link_if 'summary.txt'   "ftp/$port/summary.txt")")
    link_items+=("$(make_link_if 'downloaded/'   "ftp/$port/downloaded" allow_empty)")

    # any extras beyond known names
    shopt -s nullglob
    local fpath fbn rel
    for fpath in "$portdir"/*; do
      [ -f "$fpath" ] || continue
      fbn="$(basename "$fpath")"
      case "$fbn" in
        listing.txt|summary.txt)
          continue
          ;;
      esac
      rel="ftp/$port/$fbn"
      link_items+=("$(make_link_if "$fbn" "$rel" allow_empty)")
    done
    shopt -u nullglob

    local links
    links="$(emit_links "${link_items[@]}")"

    {
      echo "<div class=\"lantern-port\">"
      echo "  <h4>Port <code>$port</code> — FTP</h4>"
      echo "  <div class=\"lantern-meta\">"
      echo "    <strong>Anonymous login:</strong> $(html_escape <<< "$login_ok")"
      echo "    &nbsp;•&nbsp; <strong>Permissions:</strong> $esc_perms"
      echo "    &nbsp;•&nbsp; <strong>Dirs:</strong> $dircount"
      echo "    &nbsp;•&nbsp; <strong>Files:</strong> $filecount"
      echo "  </div>"
      echo "  <div class=\"lantern-files\">${links:-<em>No FTP artifacts.</em>}</div>"
    } >> "$frag"

    # Inline SUMMARY preview (two-column, scrollable)
    if [ -s "$portdir/summary.txt" ]; then
      echo "  <details open style=\"margin-top:.4rem\"><summary>FTP Summary Preview</summary><pre class=\"lantern-pre-twocol\">" >> "$frag"
      sed -n '1,300p' "$portdir/summary.txt" | html_escape >> "$frag"
      echo "  </pre></details>" >> "$frag"
    fi

    # Inline LISTING preview (two-column, scrollable)
    if [ -s "$portdir/listing.txt" ]; then
      echo "  <details open style=\"margin-top:.4rem\"><summary>Directory Listing Preview</summary><pre class=\"lantern-pre-twocol\">" >> "$frag"
      sed -n '1,300p' "$portdir/listing.txt" | html_escape >> "$frag"
      echo "  </pre></details>" >> "$frag"
    fi

    echo "</div>" >> "$frag"
  done
}

# ---------------- DNS summary fragment (08-dns.html) ----------------
build_dns_fragment() {
  local frag="$FRAGDIR/08-dns.html"

  if [ ! -d "$OUTDIR/dns" ]; then
    return 0
  fi

  local ports=()
  mapfile -t ports < <(find "$OUTDIR/dns" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort -n)
  [ ${#ports[@]} -eq 0 ] && return 0

  : > "$frag"
  echo "<h3>DNS Summary</h3>" >> "$frag"

  local port portdir
  for port in "${ports[@]}"; do
    portdir="$OUTDIR/dns/$port"
    [ -d "$portdir" ] || continue

    local domain ns_count
    domain=""
    ns_count="0"

    if [ -s "$portdir/summary.txt" ]; then
      domain="$(grep -m1 '^Domain guess:' "$portdir/summary.txt" | sed 's/.*Domain guess:[[:space:]]*//')"
      ns_count="$(grep -m1 '^NS count:' "$portdir/summary.txt" | sed 's/.*NS count:[[:space:]]*//')"
    fi

    local esc_domain
    esc_domain="$(printf '%s' "$domain" | html_escape)"

    local link_items=()
    link_items+=("$(make_link_if 'summary.txt'       "dns/$port/summary.txt")")
    link_items+=("$(make_link_if 'records.txt'       "dns/$port/records.txt" allow_empty)")
    link_items+=("$(make_link_if 'ns.txt'            "dns/$port/ns.txt" allow_empty)")
    link_items+=("$(make_link_if 'reverse.txt'       "dns/$port/reverse.txt" allow_empty)")
    link_items+=("$(make_link_if 'zone-transfer.txt' "dns/$port/zone-transfer.txt" allow_empty)")
    link_items+=("$(make_link_if 'dnsenum.txt'       "dns/$port/dnsenum.txt" allow_empty)")

    local links
    links="$(emit_links "${link_items[@]}")"

    {
      echo "<div class=\"lantern-port\">"
      echo "  <h4>Port <code>$port</code> — DNS</h4>"
      echo "  <div class=\"lantern-meta\">"
      if [ -n "$esc_domain" ]; then
        echo "    <strong>Domain guess:</strong> $esc_domain &nbsp;•&nbsp; <strong>NS count:</strong> ${ns_count:-0}"
      else
        echo "    <strong>Domain guess:</strong> <em>none</em> &nbsp;•&nbsp; <strong>NS count:</strong> ${ns_count:-0}"
      fi
      echo "  </div>"
      echo "  <div class=\"lantern-files\">${links:-<em>No DNS artifacts.</em>}</div>"
    } >> "$frag"

    # Inline DNS summary preview
    if [ -s "$portdir/summary.txt" ]; then
      echo "  <details open style=\"margin-top:.4rem\"><summary>DNS Summary Preview</summary><pre class=\"lantern-pre-twocol\">" >> "$frag"
      sed -n '1,300p' "$portdir/summary.txt" | html_escape >> "$frag"
      echo "  </pre></details>" >> "$frag"
    fi

    echo "</div>" >> "$frag"
  done
}

# ---------------- HTTP summary fragment (10-http.html) ----------------
build_http_fragment() {
  local frag="$FRAGDIR/10-http.html"
  : > "$frag"

  echo '<h3>HTTP Summary</h3>' >> "$frag"

  if [ ! -d "$OUTDIR/http" ]; then
    echo '<p><em>No HTTP artifacts found.</em></p>' >> "$frag"
    return
  fi

  # ports as baselines, sorted numerically
  local ports=()
  mapfile -t ports < <(find "$OUTDIR/http" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort -n)

  if [ ${#ports[@]} -eq 0 ]; then
    echo '<p><em>No HTTP artifacts found.</em></p>' >> "$frag"
    return
  fi

  local port portdir
  for port in "${ports[@]}"; do
    portdir="$OUTDIR/http/$port"
    [ -d "$portdir" ] || continue

    local title esc_title
    if [ -s "$portdir/title.txt" ]; then
      title="$(tr -d '\r\n' < "$portdir/title.txt")"
    else
      title="(no title collected)"
    fi
    esc_title="$(printf '%s' "$title" | html_escape)"

    local hosts_count emails_count body_html_sz body_json_sz
    hosts_count="$(safe_count "$portdir/hosts_from_body.txt")"
    emails_count="$(safe_count "$portdir/emails.txt")"
    body_html_sz="$(safe_size "$portdir/body.html")"
    body_json_sz="$(safe_size "$portdir/body.json")"

    local link_items=()
    link_items+=("$(make_link_if 'body.html'   "http/$port/body.html")")
    link_items+=("$(make_link_if 'body.json'   "http/$port/body.json" allow_empty)")
    link_items+=("$(make_link_if 'headers'     "http/$port/headers.txt")")
    link_items+=("$(make_link_if 'robots'      "http/$port/robots.txt")")
    link_items+=("$(make_link_if 'sitemap'     "http/$port/sitemap.xml")")
    link_items+=("$(make_link_if 'whatweb'     "http/$port/whatweb.txt")")
    link_items+=("$(make_link_if 'emails'      "http/$port/emails.txt")")
    link_items+=("$(make_link_if 'hosts'       "http/$port/hosts_from_body.txt")")
    link_items+=("$(make_link_if 'cert'        "http/$port/cert.txt")")

    local extra_items=()
    shopt -s nullglob
    local fpath
    for fpath in "$portdir"/*; do
      [ -f "$fpath" ] || continue
      local bn rel
      bn="$(basename "$fpath")"
      [ "$bn" = "title.txt" ] && continue
      case "$bn" in
        body.html|body.json|headers.txt|robots.txt|sitemap.xml|whatweb.txt|emails.txt|hosts_from_body.txt|cert.txt)
          continue
          ;;
      esac
      rel="http/$port/$bn"
      extra_items+=( "$(make_link_if "$bn" "$rel" allow_empty)" )
    done
    shopt -u nullglob

    local links
    links="$(emit_links "${link_items[@]}" "${extra_items[@]}")"

    cat >> "$frag" <<PORT
<div class="lantern-port">
  <h4>Port <code>$port</code> — $esc_title</h4>
  <div class="lantern-meta">
    hosts_from_body: $hosts_count &nbsp;•&nbsp; emails: $emails_count &nbsp;•&nbsp; body.html bytes: $body_html_sz &nbsp;•&nbsp; body.json bytes: $body_json_sz
  </div>
  <div class="lantern-files">
    ${links:-<em>No per-port artifacts present.</em>}
  </div>
PORT

    # Inline WhatWeb output in two-column block (scrollable)
    if [ -s "$portdir/whatweb.txt" ]; then
      {
        echo '  <details open style="margin-top:.4rem">'
        echo '    <summary>WhatWeb Output</summary>'
        echo '    <pre class="lantern-pre-twocol">'
        sed -n '1,400p' "$portdir/whatweb.txt" | html_escape
        echo '    </pre>'
        echo '  </details>'
      } >> "$frag"
    fi

    echo "</div>" >> "$frag"
  done
}

# ---------------- CMS findings fragment (20-cms.html) ----------------
build_cms_fragment() {
  local frag="$FRAGDIR/20-cms.html"
  mapfile -d '' cms_dirs < <(find "$OUTDIR/http" -maxdepth 2 -type d -name cms -print0 2>/dev/null || true)
  [ ${#cms_dirs[@]} -eq 0 ] && return 0

  local qualified=()
  local cmsdir
  for cmsdir in "${cms_dirs[@]}"; do
    [ -s "$cmsdir/detected.txt" ] && qualified+=("$cmsdir")
  done
  [ ${#qualified[@]} -eq 0 ] && return 0

  : > "$frag"
  echo '<h3>CMS Findings</h3>' >> "$frag"

  for cmsdir in "${qualified[@]}"; do
    local port detected_raw detected_display
    port="$(basename "$(dirname "$cmsdir")")"
    detected_raw="$(tr -d '\r' < "$cmsdir/detected.txt")"
    detected_display="$(printf '%s\n' "$detected_raw" | paste -sd',' - | sed 's/,/, /g')"

    {
      echo "<div class=\"lantern-port\">"
      echo "  <h4>Port <code>$port</code></h4>"
      echo "  <div class=\"lantern-meta\"><strong>Detected:</strong> $(printf '%s' "$detected_display" | html_escape)</div>"
    } >> "$frag"

    # ----- WordPress block -----
    if grep -qi '^wordpress$' "$cmsdir/detected.txt"; then
      local wdir links_wp
      wdir="http/$port/cms/wordpress"
      links_wp=()
      links_wp+=("$(make_link_if 'summary.txt' "$wdir/summary.txt")")
      links_wp+=("$(make_link_if 'wpscan.txt'   "$wdir/wpscan.txt")")
      links_wp+=("$(make_link_if 'wpscan.json'  "$wdir/wpscan.json")")

      if printf '%s\n' "${links_wp[*]}" | grep -q '[^[:space:]]'; then
        echo "  <div class=\"lantern-files\"><strong>WordPress:</strong> $(emit_links "${links_wp[@]}")</div>" >> "$frag"
      fi

      # Inline WordPress summary in two-column block
      if [ -s "$OUTDIR/$wdir/summary.txt" ]; then
        echo "  <details open style=\"margin-top:.4rem\"><summary>Preview WordPress summary.txt</summary><pre class=\"lantern-pre-twocol\">" >> "$frag"
        tail -n 200 "$OUTDIR/$wdir/summary.txt" | html_escape >> "$frag"
        echo "  </pre></details>" >> "$frag"
      fi
    fi

    # ----- Joomla block -----
    if grep -qi '^joomla$' "$cmsdir/detected.txt"; then
      local jdir links_j
      jdir="http/$port/cms/joomla"
      links_j=()
      links_j+=("$(make_link_if 'summary.txt'   "$jdir/summary.txt")")

      if printf '%s\n' "${links_j[*]}" | grep -q '[^[:space:]]'; then
        echo "  <div class=\"lantern-files\"><strong>Joomla:</strong> $(emit_links "${links_j[@]}")</div>" >> "$frag"
      fi

      # Inline JoomScan output in same two-column style
      if [ -s "$OUTDIR/$jdir/joomscan.txt" ]; then
        echo "  <details open style=\"margin-top:.4rem\"><summary>View Joomla scan details (JoomScan)</summary><pre class=\"lantern-pre-twocol\">" >> "$frag"
        sed -n '1,400p' "$OUTDIR/$jdir/joomscan.txt" \
          | sed -r 's/\x1B\[[0-9;]*[A-Za-z]//g' \
          | html_escape >> "$frag"
        echo "  </pre></details>" >> "$frag"
      fi
    fi

    echo "</div>" >> "$frag"
  done
}

## CSS
TMP="$(mktemp)"
cat "$rootdir/lib/report-style" > "$TMP"

## build module fragments
build_ssh_fragment
build_ftp_fragment
build_dns_fragment

# LDAP fragment via module helper
if [ -f "$rootdir/modules/ldap/ldap-reporter" ]; then
  ldap_frag="$FRAGDIR/09-ldap.html"
  bash "$rootdir/modules/ldap/ldap-reporter" "$OUTDIR" > "$ldap_frag" 2>/dev/null || true
  # If helper produced nothing, remove the empty file so it doesn't spawn an empty section.
  [ -s "$ldap_frag" ] || rm -f "$ldap_frag"
fi

build_http_fragment
build_cms_fragment

# Treasure fragment via treasure-reporter
if [ -x "$TREASURE_REPORTER" ]; then
  treasure_frag="$FRAGDIR/30-treasure.html"
  "$TREASURE_REPORTER" "$OUTDIR" > "$treasure_frag" 2>/dev/null || true
  [ -s "$treasure_frag" ] || rm -f "$treasure_frag"
fi

if compgen -G "$FRAGDIR"/* >/dev/null; then
  for f in $(ls -1v "$FRAGDIR"/*); do
    echo "<section class=\"lantern-fragment\" id=\"$(basename "$f" | sed 's/[^a-zA-Z0-9_-]/_/g')\">" >> "$TMP"
    cat "$f" >> "$TMP"
    echo "</section>" >> "$TMP"
  done
else
  echo "<p><em>No module fragments produced output.</em></p>" >> "$TMP"
fi

echo "</section>" >> "$TMP"

insert_before_body_close "$IDX" "$TMP"
rm -f "$TMP"

echo -e "${yellow}[*]${end} ${purple}Reporter appended module summary to${end} ${blue}${IDX}${end}"
