#!/usr/bin/env bash
set -euo pipefail

OUTDIR="${1:-}"
TARGET="${2:-}"

if [ -z "$OUTDIR" ] || [ -z "$TARGET" ]; then
  echo "[!] http-cms: Usage: http-cms OUTDIR TARGET" >&2
  exit 2
fi

HMOD="$(cd -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
ROOTDIR="$(cd "$HMOD/../.." >/dev/null 2>&1 && pwd)"
MODDIR="$ROOTDIR/modules"

# Colors
. "$ROOTDIR/lib/colors"

VERIFIED_FILE="$OUTDIR/http/verified-ports.txt"
if [ ! -s "$VERIFIED_FILE" ]; then
  echo -e "${yellow}[!] http-cms: no verified HTTP ports file; skipping CMS scans.${end}"
  exit 0
fi

ports="$(cat "$VERIFIED_FILE" | sed 's/[^0-9]//g' | sed '/^$/d' | sort -n -u)"
[ -z "$ports" ] && { echo -e "${yellow}[!]$ http-cms: empty verified ports list; skipping.${end}"; exit 0; }

cms_found=0

for p in $ports; do
  result=0
  "$MODDIR/http/cmscans" "$OUTDIR" "$TARGET" "$p" || result=$?

  case "$result" in
    1)
      cms_found=1
      echo -e "${yellow}[*]${end} ${purple}CMS detected on${end} ${blue}${TARGET}:${p}${end} ${purple}(WordPress).${end}"
      ;;
    2)
      cms_found=1
      echo -e "${yellow}[*]${end} ${purple}CMS detected on${end} ${blue}${TARGET}:${p}${end} ${purple}(Joomla).${end}"
      ;;
    3)
      cms_found=1
      echo -e "${yellow}[*]${end} ${purple}CMS detected on${end} ${blue}${TARGET}:${p}${end} ${purple}(WordPress + Joomla).${end}"
      ;;
    0)
      # No output here â€” silent for "no CMS"
      ;;
    *)
      echo -e "${red}[!] http-cms: cmscans returned unexpected code ${result} for${end} ${blue}${TARGET}:${p}${end}"
      ;;
  esac
done

if [ "$cms_found" -eq 0 ]; then
  echo -e "${yellow}  [!] No CMS detected on any verified HTTP ports.${end}"
fi


exit 0
