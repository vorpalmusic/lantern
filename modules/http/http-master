#!/usr/bin/env bash
set -euo pipefail

OUTDIR="${1:-}"
TARGET="${2:-}"

if [ -z "$OUTDIR" ] || [ -z "$TARGET" ]; then
  echo "[!] http-master: Usage: http-master OUTDIR TARGET" >&2
  exit 2
fi

if [ ! -d "$OUTDIR" ]; then
  echo "[!] http-master: OUTDIR '$OUTDIR' does not exist" >&2
  exit 2
fi

# Figure out where we are: $ROOTDIR/modules/http/http-master
HTTPMOD="$(cd -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
ROOTDIR="$(cd "$HTTPMOD/../.." >/dev/null 2>&1 && pwd)"
REPORTDIR="$OUTDIR/report"

# Load colors for pretty output
if [ -f "$ROOTDIR/lib/colors" ]; then
  # shellcheck source=/dev/null
  . "$ROOTDIR/lib/colors"
else
  # fall back to no colors
  yellow=""; purple=""; blue=""; end=""
fi

### http-detect
eval "$("$HTTPMOD/http-detect" "$OUTDIR" "$TARGET")"
echo -e "${yellow}[*]${end} ${purple}HTTP candidates:${end} ${blue}${HTTP_CAND:-<none>}${end}"
echo -e "${yellow}[*]${end} ${purple}Verified HTTP ports:${end} ${blue}${HTTP_VERIFIED:-<none>}${end}"

### http-collect
if [ -n "${HTTP_VERIFIED:-}" ]; then
  for p in $(echo "${HTTP_VERIFIED}" | tr ',' ' '); do
    p="${p//[^0-9]/}"
    [ -z "$p" ] && continue

    "$HTTPMOD/http-collect" "$OUTDIR" "$TARGET" "$p" >/dev/null 2>&1 || true
  done
fi
# --- end collect ---

# --- show emails we scraped from the HTTP bodies (if any) ---
emails_tmp="$OUTDIR/.emails.tmp"
: > "$emails_tmp"
if [ -n "${HTTP_VERIFIED:-}" ]; then
  for p in $(echo "${HTTP_VERIFIED}" | tr ',' ' '); do
    f="$OUTDIR/http/$p/emails.txt"
    [ -s "$f" ] && cat "$f" >> "$emails_tmp"
  done
fi
if [ -s "$emails_tmp" ]; then
  emails_sorted="$(sort -u "$emails_tmp")"
  echo -e "${yellow}[*]${end} ${purple}Emails found in page content:${end}"
  while IFS= read -r e; do
    echo -e "   ${blue}${e}${end}"
  done <<< "$emails_sorted"
fi
rm -f "$emails_tmp"
# --- end emails summary ---

# assume HTTP_CAND contains e.g. s3.thetoppers.htb and HTTP_VERIFIED contains ports
target_hint="${HTTP_CAND:-$TARGET}"
found_hosts="$("$HTTPMOD/enrich" "$OUTDIR" "$target_hint" --max 200)"
echo -e "${yellow}[*]${end} ${purple}Domains found:${end}"
echo "$found_hosts" | sed '/^$/d' | while IFS= read -r h; do
  echo -e "   ${blue}$h${end}"
done

# --- Add /etc/hosts entries ONCE (denylist-aware) ---
DENYLIST="$ROOTDIR/lists/deny-domains"
added="$(sudo bash "$ROOTDIR/scripts/add-hosts" "$OUTDIR" "$TARGET" "${HTTP_VERIFIED:-}" --deny-file "$DENYLIST")"
if [ -n "$added" ]; then
  echo -e "${yellow}[*]${end} ${purple}Hosts added to /etc/hosts:${end}"
  echo "$added"
else
  echo -e "${yellow}[*]${end} ${purple}No new /etc/hosts entries needed.${end} \n"
fi

# --- CMS scans (run after enrich and hosts setup) ---
if [ -n "${HTTP_VERIFIED:-}" ]; then
  for p in $(echo "${HTTP_VERIFIED}" | tr ',' ' '); do
    p="${p//[^0-9]/}"
    [ -z "$p" ] && continue
    "$HTTPMOD/cmscans" "$OUTDIR" "$TARGET" "$p" || true
  done
fi
# --- end CMS scans ---
