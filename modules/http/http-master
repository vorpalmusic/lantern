#!/usr/bin/env bash
set -euo pipefail

OUTDIR="${1:-}"
TARGET="${2:-}"

if [ -z "$OUTDIR" ] || [ -z "$TARGET" ]; then
  echo "[!] http-master: Usage: http-master OUTDIR TARGET" >&2
  exit 2
fi

# Resolve ROOTDIR from modules/http/http-master
HMOD="$(cd -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
ROOTDIR="$(cd "$HMOD/../.." >/dev/null 2>&1 && pwd)"
MODDIR="$ROOTDIR/modules"
LISTDIR="$ROOTDIR/lists"

# Colors if available
if [ -f "$ROOTDIR/lib/colors" ]; then
  # shellcheck source=/dev/null
  . "$ROOTDIR/lib/colors"
else
  yellow=""; purple=""; blue=""; end=""
fi

mkdir -p "$OUTDIR/http"

# --- HTTP detect (reuses existing helper) ---
eval "$("$MODDIR/http/http-detect" "$OUTDIR" "$TARGET")"

echo -e "${yellow}[*]${end} ${purple}HTTP candidates:${end} ${blue}${HTTP_CAND:-<none>}${end}"
echo -e "${yellow}[*]${end} ${purple}Verified HTTP ports:${end} ${blue}${HTTP_VERIFIED:-<none>}${end}"

# Persist verified ports for downstream modules (e.g. http-cms)
VERIFIED_FILE="$OUTDIR/http/verified-ports.txt"
: > "$VERIFIED_FILE"
if [ -n "${HTTP_VERIFIED:-}" ]; then
  echo "$HTTP_VERIFIED" | tr ',' '\n' | sed 's/[^0-9]//g' | sed '/^$/d' | sort -n -u > "$VERIFIED_FILE"
fi

# --- HTTP collect per verified port ---
if [ -n "${HTTP_VERIFIED:-}" ]; then
  for p in $(echo "$HTTP_VERIFIED" | tr ',' ' '); do
    p="${p//[^0-9]/}"
    [ -z "$p" ] && continue
    "$MODDIR/http/http-collect" "$OUTDIR" "$TARGET" "$p" >/dev/null 2>&1 || true
  done
fi

# --- Emails summary ---
emails_tmp="$OUTDIR/.emails.tmp"
: > "$emails_tmp"

if [ -n "${HTTP_VERIFIED:-}" ]; then
  for p in $(echo "$HTTP_VERIFIED" | tr ',' ' '); do
    p="${p//[^0-9]/}"
    [ -z "$p" ] && continue
    f="$OUTDIR/http/$p/emails.txt"
    [ -s "$f" ] && cat "$f" >> "$emails_tmp"
  done
fi

if [ -s "$emails_tmp" ]; then
  emails_sorted="$(sort -u "$emails_tmp")"
  echo -e "${yellow}[*]${end} ${purple}Emails found in page content:${end}"
  while IFS= read -r e; do
    echo -e "   ${blue}${e}${end}"
  done <<< "$emails_sorted"
fi
rm -f "$emails_tmp"

# --- Domains enrichment ---
target_hint="${HTTP_CAND:-$TARGET}"
found_hosts="$("$MODDIR/http/enrich" "$OUTDIR" "$target_hint" --max 200)"
echo -e "${yellow}[*]${end} ${purple}Domains found:${end}"
echo "$found_hosts" | sed '/^$/d' | while IFS= read -r h; do
  echo -e "   ${blue}$h${end}"
done

# --- /etc/hosts additions (denylist-aware) ---
added="$(sudo bash "$ROOTDIR/scripts/add-hosts" "$OUTDIR" "$TARGET" "${HTTP_VERIFIED:-}" --deny-file "$LISTDIR/deny-domains" 2>/dev/null || true)"
if [ -n "$added" ]; then
  echo -e "${yellow}[*]${end} ${purple}Hosts added to /etc/hosts:${end}"
  echo "$added"
else
  echo -e "${yellow}[*]${end} ${purple}No new /etc/hosts entries needed.${end}"
fi

exit 0
