#!/usr/bin/env bash
# ldap-groups â€” derive high-priv group summary + Exchange "smell" from LDAP artifacts
# Usage:
#   ldap-groups OUTDIR TARGET PORT
#
# Expects (already created by ldap-master):
#   OUTDIR/ldap/<PORT>/groups.txt
#   OUTDIR/ldap/<PORT>/users.txt
#
# Emits:
#   OUTDIR/ldap/<PORT>/groups-priv.txt        (high-priv group summary)
#   OUTDIR/ldap/<PORT>/ldap-groups-status.txt (EXCHANGE_SMELL=YES|NO)

ROOTDIR="$(cd -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")/../.." >/dev/null 2>&1 && pwd)"
. "$ROOTDIR/lib/colors"

OUTDIR="${1:-}"
TARGET="${2:-}"   # currently unused; kept for symmetry/logging if needed
PORT="${3:-}"

if [ -z "$OUTDIR" ] || [ -z "$PORT" ]; then
  echo "[!] ldap-groups: Usage: ldap-groups OUTDIR TARGET PORT" >&2
  exit 2
fi

LDAPDIR="$OUTDIR/ldap/$PORT"
if [ ! -d "$LDAPDIR" ]; then
  echo "[*] ldap-groups: No LDAP dir: $LDAPDIR"
  exit 0
fi

GROUPS_FILE="$LDAPDIR/groups.txt"
USERS_FILE="$LDAPDIR/users.txt"
PRIVGROUP_FILE="$LDAPDIR/groups-priv.txt"
STATUS_FILE="$LDAPDIR/ldap-groups-status.txt"

: >"$PRIVGROUP_FILE"
: >"$STATUS_FILE"

# --- High-privilege group summary (Domain Admins, EAs, SAs, etc.) ---
if [ -s "$GROUPS_FILE" ]; then
  awk '
    BEGIN { RS=""; FS="\n" }
    {
      sam=""; name=""; members=0
      for (i=1; i<=NF; i++) {
        line=$i
        if (line ~ /^sAMAccountName:[[:space:]]*/) { sam=line; sub(/^sAMAccountName:[[:space:]]*/, "", sam) }
        else if (line ~ /^name:[[:space:]]*/)      { name=line; sub(/^name:[[:space:]]*/, "", name) }
        else if (line ~ /^member:[[:space:]]*/)    { members++ }
      }
      if (sam=="" && name=="") next
      lname = tolower(name)
      lsam  = tolower(sam)
      gname = name
      if (gname=="") gname=sam

      grp=""
      if (lname ~ /domain admins/      || lsam ~ /domain admins/)      grp="Domain Admins"
      else if (lname ~ /enterprise admins/  || lsam ~ /enterprise admins/)  grp="Enterprise Admins"
      else if (lname ~ /^administrators$/   || lsam ~ /^administrators$/)   grp="Administrators"
      else if (lname ~ /backup operators/   || lsam ~ /backup operators/)   grp="Backup Operators"
      else if (lname ~ /account operators/  || lsam ~ /account operators/)  grp="Account Operators"

      if (grp != "") {
        printf "%s|%s|%d\n", grp, gname, members
      }
    }
  ' "$GROUPS_FILE" >"$PRIVGROUP_FILE" 2>/dev/null || true
fi

# --- Service smells (Exchange) ---
exchange_smell="NO"
if [ -s "$USERS_FILE" ]; then
  if grep -qi 'HealthMailbox\|SystemMailbox\|Microsoft Exchange' "$USERS_FILE" 2>/dev/null; then
    exchange_smell="YES"
  fi
fi

echo "EXCHANGE_SMELL=$exchange_smell" >"$STATUS_FILE"

echo -e "${cyan}    [*] [ldap-groups]: high-priv groups + service smells analyzed for LDAP${end} ${blue}port $PORT${end}"
exit 0
