#!/usr/bin/env bash
# ldap-reporter — build a single aggregated LDAP fragment for reporter
# Usage:
#   ldap-reporter OUTDIR
#
# Expects:
#   OUTDIR/ldap/<PORT>/summary.txt + other LDAP artifacts
# Emits:
#   HTML fragment to stdout (or nothing if no LDAP dirs)

OUTDIR="$1"
[ -n "$OUTDIR" ] || exit 0

LDAPDIR="$OUTDIR/ldap"
[ -d "$LDAPDIR" ] || exit 0

# --- small helpers (local to this helper) ---

html_escape() {
  sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'
}

emit_links() {
  local sep=""
  local item
  for item in "$@"; do
    [ -n "$item" ] || continue
    printf "%s%s" "$sep" "$item"
    sep=" | "
  done
}

# relpath is relative to OUTDIR (same convention as scripts/reporter)
make_link_if() {
  local label="$1" relpath="$2" mode="${3:-nonempty}"
  local abspath="$OUTDIR/$relpath"

  if [ "$mode" = "allow_empty" ]; then
    [ -e "$abspath" ] || return 0
  else
    [ -s "$abspath" ] || return 0
  fi

  printf '<a href="../%s">%s</a>' "$relpath" "$label"
}

# Extract a section from summary.txt, e.g. "[ Interesting Users ]"
extract_section() {
  local file="$1" header="$2"
  [ -s "$file" ] || return 0
  awk -v H="$header" '
    $0 == H { insec=1; next }
    /^\[.*\]/ && insec { exit }
    insec { print }
  ' "$file"
}

# Join arguments with ", "
join_csv() {
  local joined=""
  local first=1
  local x
  for x in "$@"; do
    [ -n "$x" ] || continue
    if [ $first -eq 1 ]; then
      joined="$x"
      first=0
    else
      joined="$joined, $x"
    fi
  done
  printf '%s' "$joined"
}

# --- collect LDAP ports under OUTDIR/ldap/* ---

ports=()
while IFS= read -r d; do
  ports+=("$d")
done < <(find "$LDAPDIR" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort -n)

[ ${#ports[@]} -eq 0 ] && exit 0

primary_port="${ports[0]}"
primary_summary="$LDAPDIR/$primary_port/summary.txt"

# --- Directory overview from primary port ---

DomainDN=""
ForestDN=""
IsAD=""

if [ -s "$primary_summary" ]; then
  DomainDN="$(grep -m1 '^Domain DN:' "$primary_summary" 2>/dev/null | sed 's/.*Domain DN:[[:space:]]*//')"
  ForestDN="$(grep -m1 '^Forest DN:' "$primary_summary" 2>/dev/null | sed 's/.*Forest DN:[[:space:]]*//')"
  IsAD="$(grep -m1 '^Is Active Directory:' "$primary_summary" 2>/dev/null | sed 's/.*Is Active Directory:[[:space:]]*//')"
fi

esc_domain="$(printf '%s' "$DomainDN" | html_escape)"
esc_forest="$(printf '%s' "$ForestDN" | html_escape)"
esc_isad="$(printf '%s' "$IsAD" | html_escape)"

# --- Interesting users (from primary summary) ---

interesting_block=""
if [ -s "$primary_summary" ]; then
  interesting_block="$(extract_section "$primary_summary" "[ Interesting Users ]" 2>/dev/null || true)"
fi

have_interesting=""
interesting_names_str=""

if [ -n "$interesting_block" ] && ! printf '%s\n' "$interesting_block" | grep -qi '(none detected)'; then
  # Strip leading/trailing whitespace, drop blanks, join as csv
  interesting_names_str="$(
    printf '%s\n' "$interesting_block" \
      | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' \
      | sed '/^$/d' \
      | paste -sd',' - \
      | sed 's/,/, /g'
  )"
  if [ -n "$interesting_names_str" ]; then
    have_interesting="yes"
  fi
fi

# --- Pre-scan ports for Anonymous Bind summary ---

anon_yes_ports=()

for port in "${ports[@]}"; do
  summary="$LDAPDIR/$port/summary.txt"
  [ -s "$summary" ] || continue

  anon_bind="$(grep -im1 '^Anonymous bind:' "$summary" 2>/dev/null | sed 's/^[^:]*:[[:space:]]*//')"
  [ -z "$anon_bind" ] && anon_bind="unknown"

  anon_lower="$(printf '%s' "$anon_bind" | tr 'A-Z' 'a-z')"
  case "$anon_lower" in
    yes|true)
      anon_yes_ports+=("$port")
      ;;
  esac
done

anon_yes_str="$(join_csv "${anon_yes_ports[@]}")"

# --- emit fragment HTML ---

{
  echo '<h3>LDAP Summary</h3>'
  echo '<div class="lantern-port">'
  echo '  <h4>Directory Overview</h4>'

  # Top-level directory line (domain / forest / AD)
  echo '  <div class="lantern-meta lantern-meta-inline">'
  if [ -n "$esc_domain" ]; then
    printf '    <span><strong>Domain DN:</strong> %s</span>' "$esc_domain"
  fi
  if [ -n "$esc_forest" ]; then
    printf '    <span><strong>Forest DN:</strong> %s</span>' "$esc_forest"
  fi
  if [ -n "$esc_isad" ]; then
    printf '    <span><strong>Active Directory:</strong> %s</span>' "$esc_isad"
  fi
  echo
  echo '  </div>'

  # --- High-value quick summary: interesting accounts + anon bind ports ---
  echo '  <div class="lantern-meta lantern-meta-inline">'
  if [ "$have_interesting" = "yes" ]; then
    printf '    <span><strong>Interesting accounts:</strong> <span class="lantern-bad">%s</span></span>' \
      "$(html_escape <<< "$interesting_names_str")"
  else
    echo '    <span><strong>Interesting accounts:</strong> none flagged</span>'
  fi

  if [ -n "$anon_yes_str" ]; then
    printf '    <span><strong>Anon bind enabled (ports):</strong> <span class="lantern-bad">%s</span></span>' \
      "$(html_escape <<< "$anon_yes_str")"
  else
    echo '    <span><strong>Anon bind:</strong> <span class="lantern-good">none (good)</span></span>'
  fi

  echo
  echo '  </div>'

  # --------- Scrollable preview (summary + users) ---------
  pdir="$LDAPDIR/$primary_port"
  primary_users="$pdir/users.txt"

  if [ -s "$primary_summary" ] || [ -s "$primary_users" ]; then
    echo '  <details open style="margin-top:.4rem"><summary>LDAP Enumeration Preview (primary port)</summary><pre class="lantern-pre-twocol">'
    if [ -s "$primary_summary" ]; then
      echo '---- summary.txt ----' | html_escape
      printf '\n'
      sed -n '1,220p' "$primary_summary" | html_escape
      printf '\n\n'
    fi
    if [ -s "$primary_users" ]; then
      echo '---- users.txt ----' | html_escape
      printf '\n'
      sed -n '1,220p' "$primary_users" | html_escape
      printf '\n\n'
    fi
    echo '  </pre></details>'
  fi

  # --------- Per-port status + artifact links (BOTTOM) ---------
  echo '  <h4 style="margin-top:.75rem;">Per-port status & artifacts</h4>'

  for port in "${ports[@]}"; do
    portdir="$LDAPDIR/$port"
    [ -d "$portdir" ] || continue
    summary="$portdir/summary.txt"

    anon_bind="unknown"
    if [ -s "$summary" ]; then
      # handle either "Anonymous Bind" or "Anonymous bind"
      anon_bind="$(grep -im1 '^Anonymous bind:' "$summary" 2>/dev/null | sed 's/^[^:]*:[[:space:]]*//')"
      [ -z "$anon_bind" ] && anon_bind="unknown"
    fi

    esc_anon="$(printf '%s' "$anon_bind" | html_escape)"

    # choose CSS class based on value (global good/bad)
    anon_lower="$(printf '%s' "$anon_bind" | tr 'A-Z' 'a-z')"
    anon_class=""
    case "$anon_lower" in
      yes|true)
        anon_class=' class="lantern-bad"'
        ;;
      no|false)
        anon_class=' class="lantern-good"'
        ;;
    esac

    # Per-port artifacts
    link_items=()
    link_items+=("$(make_link_if "summary.txt"          "ldap/$port/summary.txt")")
    link_items+=("$(make_link_if "rootdse.txt"          "ldap/$port/rootdse.txt"        allow_empty)")
    link_items+=("$(make_link_if "basedn.txt"           "ldap/$port/basedn.txt"         allow_empty)")
    link_items+=("$(make_link_if "domain.txt"           "ldap/$port/domain.txt"         allow_empty)")
    link_items+=("$(make_link_if "users.txt"            "ldap/$port/users.txt"          allow_empty)")
    link_items+=("$(make_link_if "groups.txt"           "ldap/$port/groups.txt"         allow_empty)")
    link_items+=("$(make_link_if "computers.txt"        "ldap/$port/computers.txt"      allow_empty)")
    link_items+=("$(make_link_if "spn-accounts.txt"     "ldap/$port/spn-accounts.txt"   allow_empty)")
    link_items+=("$(make_link_if "interesting.txt"      "ldap/$port/interesting.txt"    allow_empty)")
    link_items+=("$(make_link_if "users-classified.txt" "ldap/$port/users-classified.txt" allow_empty)")
    link_items+=("$(make_link_if "groups-priv.txt"      "ldap/$port/groups-priv.txt"    allow_empty)")
    link_items+=("$(make_link_if "all-objects.txt"      "ldap/$port/all-objects.txt"    allow_empty)")
    link_items+=("$(make_link_if "extra-accounts.txt"   "ldap/$port/extra-accounts.txt" allow_empty)")

    # Any extra LDAP artifacts not in the known list
    shopt -s nullglob
    for fpath in "$portdir"/*; do
      [ -f "$fpath" ] || continue
      fbn="$(basename "$fpath")"
      case "$fbn" in
        summary.txt|rootdse.txt|basedn.txt|domain.txt|users.txt|groups.txt|computers.txt|spn-accounts.txt|interesting.txt|users-classified.txt|groups-priv.txt|all-objects.txt|extra-accounts.txt)
          continue
          ;;
      esac
      rel="ldap/$port/$fbn"
      link_items+=("$(make_link_if "$fbn" "$rel" allow_empty)")
    done
    shopt -u nullglob

    links="$(emit_links "${link_items[@]}")"

    echo '  <div class="lantern-meta">'
    printf '    <strong>Port <code>%s</code>:</strong> Anonymous bind: <span%s>%s</span>' "$port" "$anon_class" "$esc_anon"
    if [ -n "$links" ]; then
      printf '<br>'
      printf ' &nbsp;•&nbsp; <strong>Artifacts:</strong> %s' "$links"
    fi
    echo
    echo '  </div>'
  done

  echo '</div>'
}
